<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>植物诊断 (上传图片 + 城市)</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 24px; }
    input, select, button { font-size: 16px; margin: 8px 0; }
    #result { margin-top: 16px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>上传植物图片并选择城市进行诊断</h1>

  <form id="uploadForm">
    <input type="file" id="imageUpload" accept="image/*" required />
    <br/>
    <label for="city">选择城市：</label>
    <select id="city">
      <option value="">--请选择城市--</option>
      <option value="Beijing">北京</option>
      <option value="Shanghai">上海</option>
      <option value="Guangzhou">广州</option>
      <option value="Shenzhen">深圳</option>
      <option value="Other">其他</option>
    </select>
    <br/>
    <button type="submit">开始诊断</button>
  </form>

  <div id="status"></div>
  <pre id="result"></pre>

  <script>
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');

    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      statusEl.innerText = '';
      resultEl.innerText = '';

      const fileInput = document.getElementById("imageUpload");
      const city = document.getElementById("city").value;

      if (!fileInput.files.length) { alert('请选择图片'); return; }
      if (!city) { alert('请选择城市'); return; }

      const file = fileInput.files[0];

      // 将图片读为 base64（data URL）
      const toDataURL = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      try {
        statusEl.innerText = '正在读取图片...';
        const dataUrl = await toDataURL(file);

        statusEl.innerText = '正在上传并请求诊断，请稍等...';
        const resp = await fetch('/api/diagnose', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: dataUrl, city })
        });

        // 尝试解析 JSON（如果服务端返回非 JSON，会抛错）
        let body;
        try {
          body = await resp.json();
        } catch (err) {
          const text = await resp.text();
          throw new Error('服务端返回非 JSON：' + text);
        }

        if (!resp.ok) {
          throw new Error(body.error || JSON.stringify(body));
        }

        statusEl.innerText = '诊断完成';
        // 显示更详细的结果
        resultEl.innerText = JSON.stringify(body, null, 2);
      } catch (err) {
        console.error(err);
        statusEl.innerText = '请求失败：' + err.message;
        resultEl.innerText = (err.stack || err.message);
      }
    });
  </script>
</body>
</html>
