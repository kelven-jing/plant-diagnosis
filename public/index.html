<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ± æ¤ç‰©è¯†åˆ«ï¼ˆç¯å¢ƒå˜é‡ç‰ˆï¼‰</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>ğŸŒ± æ¤ç‰©è¯†åˆ«ï¼ˆç¯å¢ƒå˜é‡ç‰ˆï¼‰</h1>
        
        <div class="config-display">
            <p><strong>ç©ºé—´ID:</strong> <span id="spaceIdDisplay">åŠ è½½ä¸­...</span></p>
            <p><strong>å·¥ä½œæµID:</strong> <span id="workflowIdDisplay">åŠ è½½ä¸­...</span></p>
        </div>

        <div class="form-section">
            <div class="input-group">
                <label for="position">ä½ç½®æè¿°:</label>
                <input type="text" id="position" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬æµ·æ·€åŒºå…¬å›­" required>
            </div>
            
            <div class="input-group">
                <label for="pictureFile">æ¤ç‰©å›¾ç‰‡:</label>
                <input type="file" id="pictureFile" accept="image/*" required>
                <div id="preview" class="preview"></div>
                <div id="uploadStatus" class="status"></div>
            </div>
            
            <button id="submitBtn" onclick="submitWorkflow()">
                <span id="btnText">ğŸš€ å¼€å§‹è¯†åˆ«</span>
                <span id="btnLoading" style="display: none;">â³ å¤„ç†ä¸­...</span>
            </button>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>æ­£åœ¨å¤„ç†æ¤ç‰©è¯†åˆ«...</p>
        </div>

        <div class="result-section" id="resultSection" style="display: none;">
            <h2>ğŸ¯ è¯†åˆ«ç»“æœ</h2>
            <div class="output" id="resultText"></div>
        </div>

        <div class="error-section" id="errorSection" style="display: none;">
            <h2>âŒ é”™è¯¯ä¿¡æ¯</h2>
            <div class="error" id="errorMessage"></div>
        </div>
    </div>

    <script>
        // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        fetch('/api/config')
            .then(res => res.json())
            .then(config => {
                document.getElementById('spaceIdDisplay').textContent = config.space_id;
                document.getElementById('workflowIdDisplay').textContent = config.workflow_id;
            });

        // å›¾ç‰‡é¢„è§ˆ
        document.getElementById('pictureFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('preview');
            const status = document.getElementById('uploadStatus');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="é¢„è§ˆ">`;
                    status.textContent = `å·²é€‰æ‹©: ${file.name} (${(file.size/1024).toFixed(1)}KB)`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
                status.textContent = '';
            }
        });

        async function submitWorkflow() {
            const position = document.getElementById('position').value.trim();
            const pictureFile = document.getElementById('pictureFile').files[0];
            
            if (!position || !pictureFile) {
                alert('è¯·å¡«å†™ä½ç½®å¹¶ä¸Šä¼ å›¾ç‰‡');
                return;
            }

            const btn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnLoading = document.getElementById('btnLoading');
            
            btn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';

            try {
                // ä¸Šä¼ åˆ°æœåŠ¡å™¨å›¾åºŠ
                const formData = new FormData();
                formData.append('image', pictureFile);

                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const uploadData = await uploadResponse.json();
                
                if (!uploadData.url) {
                    throw new Error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
                }

                // è°ƒç”¨å·¥ä½œæµ
                const workflowResponse = await fetch('/api/workflow', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        position: position,
                        picture: uploadData.url
                    })
                });

                const workflowData = await workflowResponse.json();
                
                if (workflowData.code === 0) {
                    document.getElementById('resultText').textContent = 
                        workflowData.data?.output || 'è¯†åˆ«å®Œæˆ';
                    document.getElementById('resultSection').style.display = 'block';
                } else {
                    throw new Error(workflowData.msg || 'å·¥ä½œæµè°ƒç”¨å¤±è´¥');
                }

            } catch (error) {
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorSection').style.display = 'block';
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                document.getElementById('loading').style.display = 'none';
            }
        }
    </script>
</body>
</html>
